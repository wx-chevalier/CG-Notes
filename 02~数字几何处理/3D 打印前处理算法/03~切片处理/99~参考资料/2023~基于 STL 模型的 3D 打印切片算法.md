# 基于 STL 模型的 3D 打印切片算法

3D 打印就是一层一层将材料堆积、成型的过程。控制成型的过程无非两种，要么按照精度要求控制能量源（激光、面光源、电子束、LCD 等）按照给定的图形工作，形成需求的形状及精度，要么控制打印头按照给定的图形运动、通过打印头的设计等控制材料的分布（FDM、DW），形成需要的形状、达到一定的精度。其核心要么控制、调制能量源，要么控制材料分布，而控制的源头都是切片图形。

3D 打印是一种制造技术，制造的对象一般都是三维的，有一定长、高、宽尺寸，具有不同形状和特征的实体。所以打印前必须先将三维实体切片，根据设计、工艺、材料等要求，设定合理的参数，选择合理的算法，将三维实体转换成一个二维图像序列，用于控制打印过程。本文将对部分切片算法进行介绍。

由于模型本身可以采用三角面片模型 STL 描述，也可以某种 CAD 软件本身定义的方式描述，例如 BRep 等。对于不同的模型定义，切片算法也不同，这里仅讨论基于 STL 三角面片模型的切片算法。

由于 STL 格式的文件嫣然已经成为一种标准格式，因此很多切片分层算法主要以 STL 格式的文件为主。STL 格式相对简单，在数据处理上比较方便， 所以基于 STL 三维模型的分层方法被广泛采用。

## 1 基本层切算法

## 1.1 面面求交法

如图所示，打印模型由 STL 的三角面片组成，给定切片平面（分层面），求出切片平面与三角面片的交线，顺序相连，即可获得切片图形的轮廓曲线，从而获得切片图形。

![算法示意图](https://pic2.zhimg.com/80/v2-e8fefb7744b5ac19b676df2a283b4db9_1440w.webp)

为了获得切片图形轮廓，需要获得三角面与分层面的交线段，即求出交线段的两个端点在 XoY 面上（切平面）的 xy 坐标。

具体步骤如下：

如图所示，空间三角形 P1P2P3 是 STL 模型上的一个三角面，已知其三个顶点的坐标分别为 P1(x1,y1,z1)，P2(x2,y2,z2)，P3(x3,y3,z3)，分层面所在的高度为 z0，产生的交线段为 AB，顶点 A(xa,ya,za)在 P1P2 边上，顶点 B(xb,yb,zb)在 P1P3 边上。以端点 A 为例，首先将线段 P1P2 投影到 XoZ 面，得到由点 P1'(x1, z1)和点 P2'(x2,z2) 组成的线段 P1'P2'，其所在直线可表示为：

![img](https://pic1.zhimg.com/80/v2-26eb96a42d7ded47aa8bbf37a7879564_1440w.webp)

已知高度为 z0 ，则可以求得端点 A 的 X 轴坐标 xa ：

![img](https://pic2.zhimg.com/80/v2-3691a00621c336ebdca3de0fb4d56245_1440w.webp)

同理可以得到端点 A 的 Y 轴坐标 ya:

![img](https://pic2.zhimg.com/80/v2-063430dcb6d55b3ac5602f1b525df255_1440w.webp)

用相同的方法可以得到端点 B 的二维坐标 (xb,yb )

![求交点坐标](https://pic1.zhimg.com/80/v2-dde51d19112f652ae269151c5014f8b4_720w.webp)

依次，求得分层面与所有相交三角面片的交线段，首尾顺序相连，即可获得切片图形的轮廓线，也就获得了切片图形。

一般的，若软件基于某几何内核开发，则面面求交属于内核的基本功能，可直接调用。

## 1.2 线面求交法

如图所示，对于给定的打印模型，在切片平面内做正交的直线组，直线组的密度与切片精度直接相关。求出直线组的每条直线与 STL 模型三角面片的交点，排序，即可获得切片图形的轮廓线，也即切片图形。

![线面求交法](https://pic3.zhimg.com/80/v2-a151ceffcc9e9a0414476c904f149cfa_720w.webp)

线面求交算法读者可自行查阅。

## 1.3 垂线求交法

上边的方法都是通过面面求交、线面求交获得轮廓线，从而直接获得切片图形，每次都只获得一个图形。垂线求交法则集中处理，先将打印模型转化为垂线组描述，再通过垂线组与切片平面求交获得切片图形，其可直接获得位图，而不是轮廓线。

垂线求交法的基本流程如下图所示。

1. 以 STL 模型向打印平面（XOY 平面）做垂线，获得模型的投影图形；
2. 从该图形上所有点（位图，根据制造分辨率确定）出发，做垂直于 XOY 平面的垂线组 Za；
3. 求 Za 与 STL 模型三角面片的交点（进点、出点），以进点、出点为起始点、终了点，生成线段组 Zb，则 Zb 可以完整表达 STL 模型，将模型以 STL 的三角面片描述方式转换为以线段组 Zb 的描述方式；
4. 给定切片平面，求与线段组 Zb 的交点集合，即可直接获得切片图形，且结果为位图。若需要获得轮廓线，则需要根据位图求边界点，排序，即可获得轮廓线表达的图形。

![垂线求交法](https://pic3.zhimg.com/80/v2-78327a00b29d7253002ea12771162386_720w.webp)

## 2 自适应切片算法

上文介绍了几种基本切片算法，可以看出都比较直接，一般给定层厚，即可获得所需的切片图形。但对于实际的制造系统，需要考虑精度、效率的平衡。3D 打印是分层制造，阶梯效应是影响精度的重要因素，所以分层厚度会直接影响表面精度。在给定表面倾斜角状态下，切层厚度越小、越精细，获得制件的表面精度越高，但所需的打印时间也相应的越长；在给定切片层厚的情况下，模型表面与 XOY 平面夹角约接近 90°，则阶梯效应越小，打印精度越高，反之则打印精度越低。而对于实际制品，一般希望获得的表面（同一个面）质量应该是均一、一致的。所以对于切片而言，能否实现变层厚，使得相同质量要求的表面，不管其倾角如何，均可获得接近的打印精度。

为了提高打印效率，同时确保表面质量一致，研究者提出了多个自适应切片算法。如下图所示，在确保表面精度相同（接近）的情况下，等层厚算法切层数为 21，而自适应层厚切层数仅为 8。

![自适应切层](https://pic3.zhimg.com/80/v2-f6a4d9b52ab92d30d9a8ab28e2577ca2_720w.webp)

### 2.1 二值比较法

二值比较法，其基本步骤如下：

1. 以最大厚度对模型进行预切层，获取下一层预切层图形；
2. 对比当前层与预切层图形，并进行二值运算。对所有位置（位图）进行二值运算，重叠的区域置 0，不重叠的区域置 1，获得对比图形；

![二值法求对比图](https://pic2.zhimg.com/80/v2-edd50ae3ade5b2883026385c6e44c7ed_720w.webp)

3. 以给定参数，用腐蚀算法等处理对比图形，判断其最大宽度。若最大宽度小于精度要求值，则预切层有效；
4. 若最大宽度不满足精度要求，则按给定规则减小切层厚度（比如取 1/2），重新预切层，重复以上步骤，直至对比图形最大宽度满足要求为止，或者达到设定的最小层厚。

## 2.2 表面倾角统计法

表面倾角统计算法的基本步骤如下：

1. 绕 Z 轴、以一定夹角创建一系列平面，这些平面与模型表面求交，获得模型表面的轮廓线；
2. 将轮廓线绕 Z 轴旋转投影到 XOZ 平面，采用微元思想对轮廓线分段, 计算得到每条轮廓线适应的分层厚度值；
3. 利用概率统计、加权求和等数学方法综合得到每一层的自适应分层层厚。

![表面倾角](https://pic1.zhimg.com/80/v2-b9ec4bb90912225bf2a10986f6ddd444_720w.webp)

## 2.3 基于尖高概念的自适应切片算法

如下图所示，如果采用等层厚的打印方式，下图中左上角的三角尖点（线）将被忽略。为了能够比较准确的打印出原始模型中的尖点（线），以及水平表面，在自适应切片中，需要找出模型中的特征并作为分层时考虑的因素。

![较高特征的表达](https://pic4.zhimg.com/80/v2-2b8b29b0ed114f50340da0846e0d3e67_720w.webp)

如下图所示，图中 7 为尖点特征，1/2/5/6 为线特征，3/4 为面特征。如果希望提高打印精度，使得这些特征在最终产品中能够被刻画，则在分层时，这些特征应位于自适应切层的控制高度平面上。

![尖高特征](https://pic4.zhimg.com/80/v2-9708ee88801a7fdca234b7fca88649b7_720w.webp)

围绕尖高问题，众多研究者提出了多种算法，研究较多。其中比较简单的一种算法是：

1. 首先识别模型中的尖高特征，并标记；
2. 根据最大切层厚度，对模型进行预切层；
3. 若某尖高特征位于预切层的第 i 层与第 i+1 层之间，则对当前第 i 层与第 i+1 层之间厚度按给定规则（比如 1/2 当前层厚）重新切层，迭代，直到满足精度要求。

## 3 STL 模型预处理

由于 STL 文件格式过于简单，存储的三角面都是相对独立的，相互之间没有任何关联，给后续数据处理和应用造成了困难。一类问题是模型可能存在错误，比如缝隙、孔洞、尖锐三角形、独立面片、交叉、重合等；另一类问题是效率低下，因为各三角形面片之间缺乏逻辑关系，切层等操作时可能需要遍历所有面片，顶点坐标也被多次重复记录存储，数据冗余（根据估算，约为 6 倍冗余）。这里我们只讨论第二类问题如何解决。

## 3.1 三角面片排序法

在某些切片算法中，需要找到所有与当前分层面相交的三角面片，为了降低搜索三角面片的时间，对 STL 模型中的三角面片进行排序，排序规则如下：

1. 以三角面片顶点中最小的 Z 坐标值对三角面片进行升序排列；
2. 若出现最小 Z 坐标相同的情况，则按照三角面片的最大 Z 坐标对它们进行降序排列；
3. 搜索三角面片时，在三角面片集合中找到第一个顶点的最小 Z 坐标值小于或等于分层面片所在高度，且其最大 Z 坐标值大于或等于分层面片所在高度的三角面片子集合；
4. 切层面仅与子集合中的三角面片求交、计算即可，不必搜索其余三角面片。

## 3.2 建立点线面的逻辑关系

若 STL 模型中的点、线、三角面之间有确定的拓扑关系，则在后续数据处理中效率会比较高。算法基本思想和实现如下：

1. 建立每个顶点的索引（ID），重复记录的顶点只出现一次；
2. 建立每条边的索引（ID），重复的边只记录一次；
3. 建立顶点与对应边索引的关联，即每条边，与之对应的顶点只有 2 个；
4. 建立每个三角面片的索引（ID）；
5. 建立三角面片与组成边的关联，遵循右手法则。

通过这样的构建，即建立了 STL 模型中所有几何对象之间的拓扑（逻辑）关系。切层时，即可根据这样的逻辑关系，快速找到相邻的点、边（线）、面，可大幅度提高效率。

## 4 参考文献

1）刘利刚，雍俊海，刘永进，许威威，杨周旺，吕琳，陈翔. 3D 打印中几何处理的研究进展与趋势[J].国际研究现状.2016

2）王德鹏. 3D 打印分层与路径规划算法的研究与应用[D].合肥工业大学. 2019

3）Mohammad Hayasi, Bahram Asiabanpour. A New Adaptive Slicing Approach for the Fully Dense Freeform Fabrication (FDFF) Process[J]. Joumal ofIntelligent Manufacturing，2013，24(4)：683-694．

4）A Dolene, I Makela．Slicing procedures for layered manufacturing techniques[J].Computer—Aided Design，1994，26(2)：119-126．
